{"https://moirai2.github.io/schema/daemon/input":["$input","$length","$regexp"],"https://moirai2.github.io/schema/daemon/bash":["outdir=$workdir/out","splitbybarcodesubstr.pl $input $outdir $length others $regexp","output=($(ls $workdir/out/*.bam))"],"https://moirai2.github.io/schema/daemon/script":{"https://moirai2.github.io/schema/daemon/script/name":"splitbybarcodesubstr.pl","https://moirai2.github.io/schema/daemon/script/code":["#!/usr/bin/perl","use strict 'vars';","use File::Basename;","use IO::File;","if(scalar(@ARGV)==0){print STDERR \"perl splitbybarcodesubstr.pl input outdir length others regexp\\n\";exit(0);}","my $input=$ARGV[0];","my $outdir=$ARGV[1];","my $length=$ARGV[2];","my $others=$ARGV[3];","my $regexp=$ARGV[4];","if(!defined($length)){$length=3;}","if(!defined($others)){$others=\"others\";}","if(!defined($regexp)){$regexp=\"CB:Z:(\\S+)\";}","mkdir($outdir);","chmod(0755,$outdir);","open(IN,\"samtools view -H $input|\");","my $basename=basename($input,\".bam\");","my @headers=();","while(<IN>){push(@headers,$_);}","close(IN);","open(IN,\"samtools view $input|\");","my $writers={};","my @outputs=();","while(<IN>){","my $barcode=$others;","if(/$regexp/){$barcode=substr($1,0,$length);}","if(!exists($writers->{$barcode})){","my $output=\"$outdir/$basename.$barcode.sam\";","push(@outputs,$output);","my $writer=IO::File->new(\">$output\");","$writers->{$barcode}=$writer;","foreach my $header(@headers){print $writer $header;}","}","my $writer=$writers->{$barcode};","print $writer $_;","}","close(IN);","foreach my $output(@outputs){","my $basename=basename($output,\".sam\");","my $command=\"samtools view -bSo $outdir/$basename.bam $output 2>/dev/null\";","system($command);","unlink($output);","}"]},"https://moirai2.github.io/schema/daemon/outputs":"$output"}
