{"https://moirai2.github.io/schema/daemon/input":"$fasta","https://moirai2.github.io/schema/daemon/bash":["basename=`basename $fasta .fa`","output=\"$workdir/$basename.txt\"","status=$(query.pl $fasta $output)"],"https://moirai2.github.io/schema/daemon/script":{"https://moirai2.github.io/schema/daemon/script/name":"query.pl","https://moirai2.github.io/schema/daemon/script/code":["#!/usr/bin/perl","use URI::Escape;","use LWP::UserAgent;","use HTTP::Request::Common qw(POST);","$ua=LWP::UserAgent->new;","my $query=$ARGV[0];","my $output=$ARGV[1];","$program=\"blastn&MEGABLAST=on\";","$database=\"nt\";","open(QUERY,$query);","while(<QUERY>){$encoded_query=$encoded_query.uri_escape($_);}","close(QUERY);","$args=\"CMD=Put&PROGRAM=$program&DATABASE=$database&QUERY=$encoded_query\";","$req=new HTTP::Request POST=>'https://blast.ncbi.nlm.nih.gov/blast/Blast.cgi';","$req->content_type('application/x-www-form-urlencoded');","$req->content($args);","$response=$ua->request($req);","$response->content=~/^    RID = (.*$)/m;","$rid=$1;","sleep 30;","open(OUT,\">$output\");","while (true){","$req=new HTTP::Request GET=>\"https://blast.ncbi.nlm.nih.gov/blast/Blast.cgi?CMD=Get&FORMAT_OBJECT=SearchInfo&RID=$rid\";","$response=$ua->request($req);","if($response->content=~/\\s+Status=WAITING/m){sleep 5;next;}","elsif($response->content=~/\\s+Status=FAILED/m){print \"failed\\n\";}","elsif($response->content=~/\\s+Status=UNKNOWN/m){print \"unknown\\n\";}","elsif($response->content=~/\\s+Status=READY/m){print \"success\\n\";last;}","else{print \"failed\\n\";}","}","sleep 30;","$req=new HTTP::Request GET=>\"https://blast.ncbi.nlm.nih.gov/blast/Blast.cgi?CMD=Get&FORMAT_TYPE=Text&RID=$rid\";","$response=$ua->request($req);","print OUT $response->content;","close(OUT);"]},"https://moirai2.github.io/schema/daemon/output":["$output","$status","$basename"]}
