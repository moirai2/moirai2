<!DOCTYPE>
<html>
	<head>
		<title>cytoscape-cola.js demo</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
		<script src="js/cytoscape/cytoscape.min.js"></script>
		<script src="js/cytoscape/cola.min.js"></script>
		<script src="js/cytoscape/cytoscape-cola.js"></script>
		<script src="js/jquery/jquery-3.4.1.min.js"></script>
		<script src="js/ah3q/dnd.js"></script>
		<style>
			body {font-family:helvetica;font-size:14px;}
			h1 {opacity:0.5;font-size:1em;}
			#cy {
				width:100%;
				height:100%;
				position:absolute;
				left:0;
				top:0;
				z-index:999;
			}
		</style>
		<script>
			var cy;
			var dnd;
			var nodes={};
			var edges=[];
			var elements={nodes:[],edges:[]};
			function handleInput(inputVars,line){
				const inputre=new RegExp("-i '(.+?)'");
				var match=line.match(inputre);
				if(match!=null){
					for(var j=1;j<match.length;j++){
						var triples=match[j].split(',');
						triples.forEach(triple=>{
							var tokens=triple.split('->');
							var sub=tokens[0];//root
							var pre=tokens[1];//input
							var obj=tokens[2];//$input
							if(obj.startsWith("$"))inputVars[obj]="$"+pre;
						});
					}
					return 1;
				}
			}
			function handleOutput(inputVars,line,index){
				const outputre=new RegExp("-o '(.+?)'");
				var match=line.match(outputre);
				if(match!=null){
					for(var j=1;j<match.length;j++){
						var triples=match[j].split(',');
						triples.forEach(triple=>{
							var tokens=triple.split('->');
							var sub=tokens[0];//root
							var pre=tokens[1];//input
							var obj=tokens[2];//$input
							console.log("output",sub,pre,obj);
							if(sub.startsWith("$")){
								var s=inputVars[sub];
								if(obj.startsWith("$")){//true edge
									var p="command"+index;
									var o="$"+pre;
									console.log("edge",s,p,o);
									addEdge(s,p,o);
								}else{
									console.log("edge",s,pre,obj);
									addEdge(s,pre,obj);
								}
							}else{
								if(obj.startsWith("$")){//true edge
									var p="command"+index;
									var o="$"+pre;
									console.log("edge",sub,p,o);
									addEdge(sub,p,o);
								}else{
									console.log(sub,pre,obj);
									addEdge(sub,pre,obj);
								}
							}
						});
					}
					return 1;
				}
			}
			function addNode(node){
				if(nodes[node]!=null)return nodes[node];
				var id="n"+Object.keys(nodes).length;
				var hash={"data":{"id":id,"label":node}};
				nodes[node]=id;
				elements["nodes"].push(hash);
				return id;
			}
			function addEdge(from,edge,to){
				var f=addNode(from);
				var t=addNode(to);
				var id="e"+elements["edges"].length;
				var hash={"data":{"id":id,"source":f,"target":t,"label":edge}};
				elements["edges"].push(hash);
			}
			function readWorkflow(text){
				const moirai2re=new RegExp('moirai2.pl');
				const continuere=new RegExp("^(.+)\\s+\\\\");
				lines=text.split(/\n/);
				var index=0;
				for(var i=0,concat=0;i<lines.length;i++,index++){
					var match=lines[i].match(continuere);
					if(match!=null){
						if(i==index){
							lines[index]=match[1];
						}else if(i>index){
							lines[index]+=" ";
							lines[index]+=match[1];
						}
						concat=1;
						index--;
						continue;
					}
					if(concat==1){lines[index]+=" "+lines[i];}
					else{lines[index]=lines[i];}
					concat=0;
				}
				var extra=lines.length-index;
				var commandIndex=0;
				for(var i=0;i<extra;i++){lines.pop();}
				lines.forEach(line=>{
					if(line.search(moirai2re)>0){
						var inputVars={};
						handleInput(inputVars,line);
						console.log(inputVars);
						handleOutput(inputVars,line,commandIndex);
						commandIndex++;
					}
				});
				console.log(elements);
				cy.json({"elements":elements});
				cy.layout({name:'cola'}).run();
			}
			$(document).ready(function(){
				dnd=new DnD("cy").whenFileIsDroppedRead().whenUrlIsDroppedRead().addEventListener("textWasRead",function(e){
					readWorkflow(e.detail.text);
				});
			});
			document.addEventListener('DOMContentLoaded', function(){
				cy = window.cy = cytoscape({
					container:document.getElementById('cy'),
					autounselectify:true,
					boxSelectionEnabled:false,
					layout:{name:'cola'},
					style:[
						{
							selector:'node',
							css:{'background-color':'#f92411'},
							style:{'label':'data(label)'}
						},{
							selector:'edge',
							css:{'line-color':'#f92411'}
						}
					]
					
				});
				cy.on("tap","edge",function(evt){
					console.log("tap edge",evt);
				});
				cy.on("tap","node",function(evt){
					console.log("tap node",evt);
				});
				cy.on("dbltap","edge",function(evt){
					console.log("dbltap edge",evt);
				});
				cy.on("dbltap","node",function(evt){
					console.log("dbltap node",evt);
				});
				cy.on("taphold","edge",function(evt){
					console.log("taphold edge",evt);
				});
				cy.on("taphold","node",function(evt){
					console.log("taphold node",evt);
				});
			});
		</script>
	</head>
	<body id="main">
		<h1>Workflow Browser</h1>
		<div id="cy"></div>
	</body>
</html>
