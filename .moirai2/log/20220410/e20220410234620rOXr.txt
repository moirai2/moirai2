######################################## e20220410234620rOXr ########################################
https://moirai2.github.io/schema/daemon/execute	completed
https://moirai2.github.io/schema/daemon/processtime	0
https://moirai2.github.io/schema/daemon/timecompleted	1649601981
https://moirai2.github.io/schema/daemon/timeended	1649601981
https://moirai2.github.io/schema/daemon/timestarted	1649601981
test/B.json#output	test/case1.sort.txt
######################################## status ########################################
registered	1649601981
start	1649601981
end	1649601981
completed	1649601981
######################################## insert ########################################
test/case1.txt	sorted	test/case1.sort.txt
######################################## bash ########################################
#!/bin/sh
export PATH=/Users/ah3q/Sites/moirai2:/Users/ah3q/Sites/moirai2/bin:/Users/ah3q/Sites/moirai2/.moirai2/bin:$PATH
cmdurl="test/B.json"
execid="e20220410234620rOXr"
workdir=".moirai2/e20220410234620rOXr"
rootdir="/Users/ah3q/Sites/moirai2"
tmpdir=".moirai2/e20220410234620rOXr/tmp"
id="case1"
input="test/case1.txt"
output=$tmpdir/output
########## init ##########
cd $rootdir
touch $workdir/status.txt
touch $workdir/log.txt
function status() { echo "$1	"`date +%s` >> $workdir/status.txt ; }
function record() { echo "$1	$2" >> $workdir/log.txt ; }
mkdir -p /tmp/$execid
ln -s /tmp/$execid $tmpdir
status start
########## command ##########
sort $input > $output
#############################
status end
mv $output test/$id.sort.txt
output=test/$id.sort.txt
if [[ "$(declare -p output)" =~ "declare -a" ]]; then
for out in ${output[@]} ; do
record "$cmdurl#output" "$out"
echo "insert $input->sorted->$out"
done
else
record "$cmdurl#output" "$output"
echo "insert $input->sorted->$output"
fi
rm $workdir/tmp
if [ -z "$(ls -A /tmp/$execid)" ]; then
rmdir /tmp/$execid
else
mv /tmp/$execid $workdir/tmp
fi
status=""
if [ -z "$status" ]; then
if [ -s $workdir/stderr.txt ]; then
status=error
fi
fi
if [ -z "$status" ]; then
status=completed
fi
status $status
sleep 1
touch $workdir/status.txt
